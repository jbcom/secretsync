# Integration test environment
# Usage:
#   docker-compose -f docker-compose.test.yml up -d localstack vault
#   make test-integration
#   docker-compose -f docker-compose.test.yml down

services:
  # LocalStack for AWS Secrets Manager emulation
  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
    environment:
      SERVICES: secretsmanager
      DEBUG: 0
      EAGER_SERVICE_LOADING: 1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 3s
      retries: 10

  # HashiCorp Vault in dev mode
  vault:
    image: hashicorp/vault:latest
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "test-root-token"
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
      VAULT_ADDR: "http://0.0.0.0:8200"
    cap_add:
      - IPC_LOCK
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 5s
      timeout: 3s
      retries: 10
    command: server -dev -dev-root-token-id="test-root-token"

  # Test runner service - runs integration tests with access to both services
  test-runner:
    image: golang:1.23
    working_dir: /app
    volumes:
      - .:/app
    depends_on:
      localstack:
        condition: service_healthy
      vault:
        condition: service_healthy
    environment:
      # Vault config
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "test-root-token"
      # AWS config (LocalStack)
      AWS_ENDPOINT_URL: "http://localstack:4566"
      AWS_ACCESS_KEY_ID: "test"
      AWS_SECRET_ACCESS_KEY: "test"
      AWS_REGION: "us-east-1"
      # Go test config
      CGO_ENABLED: "0"
    command: >
      sh -c "
        go mod download &&
        go test -v -tags=integration ./tests/integration/...
      "
